<!DOCTYPE html>
<html lang="zh">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>The Basics of Autotools – Gentoo Development Guide</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="The Gentoo Devmanual is a technical manual which covers topics such as writing ebuilds and eclasses, and policies that developers should be abiding by.">
<link href="/assets.gentoo.org/tyrian/bootstrap.min.css" rel="stylesheet" media="screen">
<link href="/assets.gentoo.org/tyrian/tyrian.min.css" rel="stylesheet" media="screen">
<link rel="stylesheet" href="../../devmanual.css" type="text/css">
<link rel="icon" href="/www.gentoo.org/favicon.ico" type="image/x-icon">
</head>
<body>
<header><div class="site-title"><div class="container"><div class="row">
<div class="site-title-buttons"><div class="btn-group btn-group-sm">
<a href="https://get.gentoo.org/" role="button" class="btn get-gentoo"><span class="fa fa-fw fa-download"></span><strong> Get Gentoo!</strong></a><div class="btn-group btn-group-sm">
<a class="btn gentoo-org-sites dropdown-toggle" data-toggle="dropdown" data-target="#" href="index.html#"><span class="fa fa-fw fa-map-o"></span><span class="hidden-xs"> gentoo.org sites </span><span class="caret"></span></a><ul class="dropdown-menu dropdown-menu-right">
<li><a href="https://www.gentoo.org/" title="Main Gentoo website"><span class="fa fa-home fa-fw"></span> gentoo.org</a></li>
<li><a href="https://wiki.gentoo.org/" title="Find and contribute documentation"><span class="fa fa-file-text-o fa-fw"></span> Wiki</a></li>
<li><a href="https://bugs.gentoo.org/" title="Report issues and find common issues"><span class="fa fa-bug fa-fw"></span> Bugs</a></li>
<li><a href="https://forums.gentoo.org/" title="Discuss with the community"><span class="fa fa-comments-o fa-fw"></span> Forums</a></li>
<li><a href="https://packages.gentoo.org/" title="Find software for your Gentoo"><span class="fa fa-hdd-o fa-fw"></span> Packages</a></li>
<li class="divider">
<li><a href="https://planet.gentoo.org/" title="Find out what's going on in the developer community"><span class="fa fa-rss fa-fw"></span> Planet</a></li>
<li><a href="https://archives.gentoo.org/" title="Read up on past discussions"><span class="fa fa-archive fa-fw"></span> Archives</a></li>
<li><a href="https://sources.gentoo.org/" title="Browse our source code"><span class="fa fa-code fa-fw"></span> Sources</a></li>
<li class="divider">
<li><a href="https://infra-status.gentoo.org/" title="Get updates on the services provided by Gentoo"><span class="fa fa-server fa-fw"></span> Infra Status</a></li>
</ul>
</div>
</div></div>
<div>
<a href="../../index.html" title="Back to the homepage" class="site-logo"><object data="/assets.gentoo.org/tyrian/site-logo.svg" type="image/svg+xml"><img src="/assets.gentoo.org/tyrian/site-logo.png" alt="Gentoo Linux Logo"></object></a><span class="site-label">Development Guide</span>
</div>
</div></div></div>
<nav class="tyrian-navbar" role="navigation"><div class="container"><div class="row">
<div class="navbar-header"><button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-main-collapse"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button></div>
<div class="collapse navbar-collapse navbar-main-collapse"><ul class="nav navbar-nav">
<li><a href="../../index.html"><span class="fa fa-home"></span> Home</a></li>
<li class="dropdown">
<a href="index.html#" class="dropdown-toggle" data-toggle="dropdown">Index <span class="caret"></span></a><ul class="dropdown-menu">
<li><a class="reference" href="index.html#major-autotools-components">Major Autotools Components</a></li>
<li><a class="reference" href="index.html#simple-autotools-patching-example">Simple Autotools Patching Example</a></li>
<li><a class="reference" href="index.html#the-configure.ac-file">The configure.ac File</a></li>
<li><a class="reference" href="index.html#the-makefile.am-files">The Makefile.am Files</a></li>
<li><a class="reference" href="index.html#the-config.h.in-file">The config.h.in File</a></li>
<li><a class="reference" href="index.html#aclocal-and-m4-files">aclocal and m4 Files</a></li>
<li><a class="reference" href="index.html#libtool">Libtool</a></li>
<li><a class="reference" href="index.html#further-autotools-reading">Further Autotools Reading</a></li>
</ul>
</li>
<li><a class="w-250 text-center" href="../index.html"><span class="fa fa-arrow-left"></span><span class="truncated-text d-inline-block max-w-200 ml-2">General Concepts</span></a></li>
<li><a class="w-250 text-center" href="../config-protect/index.html"><span class="truncated-text d-inline-block max-w-200 mr-2">Configuration File Protection</span><span class="fa fa-arrow-right"></span></a></li>
</ul></div>
</div></div></nav><nav class="navbar navbar-grey navbar-stick" id="devmanual-actions" role="navigation"><div class="container"><div class="row"><div class="input-group">
<input type="search" name="search" placeholder="Search" title="Search Gentoo Developer Manual [f]" accesskey="f" id="searchInput" class="form-control" onclick="fetchDocuments()"><div class="input-group-btn"><input type="submit" name="fulltext" value="Search" title="Search the pages for this text" id="mw-searchButton" class="searchButton btn btn-default" onclick="search()"></div>
</div></div></div></nav><div id="searchResults" class="modal fade" role="dialog"><div class="modal-dialog"><div class="modal-content">
<div class="modal-header">
<button type="button" class="close" data-dismiss="modal">x</button><h4 class="modal-title">Search Results</h4>
</div>
<div class="modal-body"><p>No results found.</p></div>
<div class="modal-footer"><button type="button" class="btn btn-default" data-dismiss="modal">Close</button></div>
</div></div></div>
<div class="container"><div class="row"><div class="col-md010"><ol class="breadcrumb">
<li><a href="../../index.html">Master Index</a></li>
<li><a href="../index.html">General Concepts</a></li>
</ol></div></div></div></header><main><div class="container">
<h1 class="first-header">Autotools 基础</h1>
<div class="alert alert-info" role="alert">
<strong>待办：</strong>
这篇文档对于 <a class="" href="../index.html">General Concepts</a> 来说太过冗长。需要拆分并移动到它自己的顶层目录，或者是<a class="" href="../../appendices/index.html">附录</a>，或者是别的什么地方。
</div>

<p>
理解 GNU autotools (例如<code class="docutils literal"><span class="pre">automake</span></code>, <code class="docutils literal"><span class="pre">autoconf</span></code>) 对于开发 ebuild 来说非常有用：
</p>

<ul>
  <li>
    定位与纠正编译问题通常会更简单，如果构建系统不能简单看作一个吓人的黑盒的话。
  </li>
  <li>
    autotools 输入文件可以帮助你确定软件包的编译时依赖。
  </li>
  <li>
    理解构建系统各文件之间的关系会使在错误的时机给错误的文件打补丁而意外搞坏某些东西的风险大大降低。
  </li>
</ul>
<div class="section">
<h2 id="major-autotools-components">Autotools 的主要组件</h2>
<p>
Autotools 是相互关联的工具的集合，当它们一起使用时，可以消除构建可移植软件所涉及到的许多困难。
这些工具和上游提供的相对简单的输入文件一起，用来为软件包创建构建系统。
</p>

<div class="figure">
<div class="image"><img alt="How autotools fits together" src="diagram.png"></div>
<p class="caption">Autotools 主要组件配合使用总览</p>
</div>

<p>
在一个简单的设置中：
</p>

<ul>
  <li>
    <code class="docutils literal"><span class="pre">autoconf</span></code> 程序根据 <code class="docutils literal"><span class="pre">configure.in</span></code> 或
    <code class="docutils literal"><span class="pre">configure.ac</span></code> 生成 <code class="docutils literal"><span class="pre">configure</span></code> 脚本（请看下面的附注）。
  </li>
  <li>
    <code class="docutils literal"><span class="pre">automake</span></code> 程序根据
    <code class="docutils literal"><span class="pre">Makefile.am</span></code> 生成 <code class="docutils literal"><span class="pre">Makefile.in</span></code>。
  </li>
  <li>
    运行 <code class="docutils literal"><span class="pre">configure</span></code> 脚本，根据 <code class="docutils literal"><span class="pre">Makefile.in</span></code> 文件生成一个或多个
    <code class="docutils literal"><span class="pre">Makefile</span></code>。
  </li>
  <li>
    <code class="docutils literal"><span class="pre">make</span></code> 程序利用 <code class="docutils literal"><span class="pre">Makefile</span></code> 编译软件。
  </li>
</ul>


<div class="alert alert-info" role="alert">
<strong>附注：</strong>
按照标准应该使用 <code class="docutils literal"><span class="pre">configure.in</span></code>，然而 GNU 文档现在推荐使用
<code class="docutils literal"><span class="pre">configure.ac</span></code> 因为处理她的时候使用哪个程序会更加明显。
这些文件具有相同的用途和相同的格式，唯一的区别是名称。
</div>

<p>
你可能会见到在多个阶段的函数中使用 autotools。
<a class="" href="../../ebuild-writing/functions/src_prepare/index.html">src_prepare</a> 函数是最适合在配置和编译之前操作代码的地方，
尤其是因为 <a class="" href="../../ebuild-writing/functions/src_configure/index.html">src_configure</a> 通常期望
<code class="docutils literal"><span class="pre">configure</span></code> 脚本存在，
而 <code class="docutils literal"><span class="pre">src_prepare</span></code> 函数在它之前调用。
</p>

<p>
据推测 <code class="docutils literal"><span class="pre">autoreconf</span></code> 工具在必要时会运行 <code class="docutils literal"><span class="pre">autoconf</span></code>（还有 <code class="docutils literal"><span class="pre">automake</span></code>，<code class="docutils literal"><span class="pre">autoheader</span></code>，<code class="docutils literal"><span class="pre">aclocal</span></code>，<code class="docutils literal"><span class="pre">autopoint</span></code> 以及 <code class="docutils literal"><span class="pre">libtoolize</span></code>）。
有时它可以工作。有些软件包会带一个名为 <code class="docutils literal"><span class="pre">autogen.sh</span></code>
的 shell 脚本来做相同的事情（这和 <code class="docutils literal"><span class="pre">autogen</span></code> 工具<i>无关</i>）。
autotools.eclass 包含了一些用来调用单个工具的辅助函数，这些辅助函数各自拥有和工具相对应的名称，例如
<code class="docutils literal"><span class="pre">eautoconf</span></code> 和 <code class="docutils literal"><span class="pre">eautomake</span></code>。
</p>

<div class="alert alert-danger" role="alert">
<strong>警告：</strong>
<b>不要</b>在执行 <code class="docutils literal"><span class="pre">configure</span></code> 和 <code class="docutils literal"><span class="pre">make</span></code>
之间修改任何生成的文件，因为这会让 autotools 智能地重新生成这些文件，导致你的修改被覆盖掉。
在某些情况下这还会导致 <code class="docutils literal"><span class="pre">./configure</span></code> 的参数神不知鬼不觉的丢失，最终破坏依赖关系。
所以通常最优的办法是修改 <code class="docutils literal"><span class="pre">.ac</span></code> 或 <code class="docutils literal"><span class="pre">.in</span></code> 文件。
</div>

</div>
<div class="section">
<h2 id="simple-autotools-patching-example">简单的 Autotools 补丁示例</h2>

<p>
下列片段说明了给 <code class="docutils literal"><span class="pre">Makefile.am</span></code>
或 <code class="docutils literal"><span class="pre">configure.ac</span></code> 打上补丁之后正确的处理方式：
</p>

<pre><span class="Constant"><span xmlns="http://www.w3.org/1999/xhtml" class="Identifier">EAPI</span><span xmlns="http://www.w3.org/1999/xhtml" class="Constant">=</span>5

<span xmlns="http://www.w3.org/1999/xhtml" class="Statement">inherit</span> autotools

<span xmlns="http://www.w3.org/1999/xhtml" class="Special">src_prepare()</span> <span xmlns="http://www.w3.org/1999/xhtml" class="PreProc">{</span>
	<span xmlns="http://www.w3.org/1999/xhtml" class="Comment">#</span> Remove problematic LDFLAGS declaration
	<span xmlns="http://www.w3.org/1999/xhtml" class="Statement">sed</span> -i -e '/^LDFLAGS/d' src/Makefile.am <span xmlns="http://www.w3.org/1999/xhtml" class="Statement">||</span> <span xmlns="http://www.w3.org/1999/xhtml" class="Statement">die</span>

	<span xmlns="http://www.w3.org/1999/xhtml" class="Comment">#</span> Rerun autotools
	<span xmlns="http://www.w3.org/1999/xhtml" class="Statement">einfo</span> <span xmlns="http://www.w3.org/1999/xhtml" class="Statement">"</span>Regenerating autotools files...<span xmlns="http://www.w3.org/1999/xhtml" class="Statement">"</span>
	<span xmlns="http://www.w3.org/1999/xhtml" class="Identifier">WANT_AUTOCONF</span><span xmlns="http://www.w3.org/1999/xhtml" class="Constant">=</span>2.5 eautoconf
	<span xmlns="http://www.w3.org/1999/xhtml" class="Identifier">WANT_AUTOMAKE</span><span xmlns="http://www.w3.org/1999/xhtml" class="Constant">=</span>1.9 eautomake
<span xmlns="http://www.w3.org/1999/xhtml" class="PreProc">}</span>

<span xmlns="http://www.w3.org/1999/xhtml" class="Special">src_compile()</span> <span xmlns="http://www.w3.org/1999/xhtml" class="PreProc">{</span>
	<span xmlns="http://www.w3.org/1999/xhtml" class="Statement">econf</span> <span xmlns="http://www.w3.org/1999/xhtml" class="PreProc">$(</span><span xmlns="http://www.w3.org/1999/xhtml" class="Statement">use_enable</span> nls<span xmlns="http://www.w3.org/1999/xhtml" class="PreProc">)</span>
	<span xmlns="http://www.w3.org/1999/xhtml" class="Statement">emake</span>
<span xmlns="http://www.w3.org/1999/xhtml" class="PreProc">}</span>
</span></pre>

<p>
运行 autotools 之前的 <code class="docutils literal"><span class="pre">einfo</span></code>
不是必须的。不过这些步骤有时候会搞了很一段长时间都没有输出，因此让用户知道操作还在进行就很有意义。
参阅 <a class="" href="../../ebuild-writing/messages/index.html">Messages</a>。
</p>

</div>
<div class="section">
<h2 id="the-configure.ac-file"><code class="docutils literal"><span class="pre">configure.ac</span></code> 文件</h2>

<p>
<code class="docutils literal"><span class="pre">configure.ac</span></code> 用来创建 <code class="docutils literal"><span class="pre">./configure</span></code> 脚本。
它由一系列的宏组成，这些宏由 <code class="docutils literal"><span class="pre">autoconf</span></code> 处理并展开。
这些宏可以检查软件包和库，处理 <code class="docutils literal"><span class="pre">--enable</span></code> 和
<code class="docutils literal"><span class="pre">--with</span></code> 开关，以及生成各种文件。
</p>

<div class="section">
<h3 id="basic-format-of-configure.ac"><code class="docutils literal"><span class="pre">configure.ac</span></code> 的基本格式
</h3>

<p>
<code class="docutils literal"><span class="pre">configure.ac</span></code> 是一个简单的文本文件。
缩进和空格在很大程度上无关紧要。注释由字符串 <code class="docutils literal"><span class="pre">dnl</span></code>
标识（<code class="docutils literal"><span class="pre">dnl</span></code> 实际上是一个用来丢弃剩余输入的宏 —— 它代表“丢弃新行”）。
</p>

<p>
如果前面的内容让你疑惑，就别再看这个页面了，那样只会让情况更糟。
</p>

<p>
一个典型的文件开头可能会像下面这样：
</p>

<pre><span class=""><span xmlns="http://www.w3.org/1999/xhtml" class="Comment">dnl</span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment"> </span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment">Process</span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment"> </span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment">this</span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment"> </span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment">file</span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment"> </span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment">with</span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment"> </span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment">autoconf</span>
<span xmlns="http://www.w3.org/1999/xhtml" class="Identifier">AC_INIT</span><span xmlns="http://www.w3.org/1999/xhtml" class="Special">(</span>appname<span xmlns="http://www.w3.org/1999/xhtml" class="Special">,</span> <span xmlns="http://www.w3.org/1999/xhtml" class="Constant">0.1</span><span xmlns="http://www.w3.org/1999/xhtml" class="Special">)</span>
<span xmlns="http://www.w3.org/1999/xhtml" class="Identifier">AC_PREREQ</span><span xmlns="http://www.w3.org/1999/xhtml" class="Special">(</span><span xmlns="http://www.w3.org/1999/xhtml" class="Constant">2.5</span><span xmlns="http://www.w3.org/1999/xhtml" class="Special">)</span>
<span xmlns="http://www.w3.org/1999/xhtml" class="Identifier">AC_CONFIG_SRCDIR</span><span xmlns="http://www.w3.org/1999/xhtml" class="Special">(</span>src/main.c<span xmlns="http://www.w3.org/1999/xhtml" class="Special">)</span>
<span xmlns="http://www.w3.org/1999/xhtml" class="Identifier">AC_CONFIG_AUX_DIR</span><span xmlns="http://www.w3.org/1999/xhtml" class="Special">(</span>config<span xmlns="http://www.w3.org/1999/xhtml" class="Special">)</span>
<span xmlns="http://www.w3.org/1999/xhtml" class="Identifier">AM_INIT_AUTOMAKE</span><span xmlns="http://www.w3.org/1999/xhtml" class="Special">(</span><span xmlns="http://www.w3.org/1999/xhtml" class="Constant">1.8</span><span xmlns="http://www.w3.org/1999/xhtml" class="Special">)</span>
</span></pre>

<p>
如果存在的话，<code class="docutils literal"><span class="pre">AC_PREREQ</span></code> 那一行告诉你需要使用什么版本的 <code class="docutils literal"><span class="pre">autoconf</span></code>。
这非常有用，因为 <code class="docutils literal"><span class="pre">autoconf</span></code> 版本之间不兼容。
在上面的例子中，调用 <code class="docutils literal"><span class="pre">autoconf</span></code> 时我们需要 <code class="docutils literal"><span class="pre">=autoconf-2.5*</span></code>，还应该
<code class="docutils literal"><span class="pre">export WANT_AUTOCONF="2.5"</span></code>（或者使用 <code class="docutils literal"><span class="pre">autoconf-2.59</span></code> 脚本）。
</p>

<p>
<code class="docutils literal"><span class="pre">AM_INIT_AUTOMAKE</span></code> 那一行告诉我们需要使用什么版本的 <code class="docutils literal"><span class="pre">automake</span></code>。
同样的，<code class="docutils literal"><span class="pre">automake-1.7</span></code> 脚本在<code class="docutils literal"><span class="pre">automake-1.8</span></code>
下正常工作的可能性很小。设置环境变量 <code class="docutils literal"><span class="pre">WANT_AUTOMAKE="1.8"</span></code> 可以使不带版本的
<code class="docutils literal"><span class="pre">automake</span></code> 命令运行正确的版本。
</p>

<div class="alert alert-info" role="alert">
<strong>附注：</strong>
<code class="docutils literal"><span class="pre">WANT_</span></code> 开头的变量是一个最初来自 Mandrake 的 Gentoo 功能。其他发行版可能会有不同的处理方式。
</div>

<p>
通常，一些标准检查会紧跟如下：
</p>

<pre><span class=""><span xmlns="http://www.w3.org/1999/xhtml" class="Comment">dnl</span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment"> </span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment">Check</span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment"> </span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment">for</span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment"> </span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment">toolchain</span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment"> </span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment">and</span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment"> </span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment">install</span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment"> </span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment">components</span>
<span xmlns="http://www.w3.org/1999/xhtml" class="Identifier">AC_PROG_CC</span>
<span xmlns="http://www.w3.org/1999/xhtml" class="Identifier">AC_PROG_INSTALL</span>
<span xmlns="http://www.w3.org/1999/xhtml" class="Identifier">AC_PROG_LN_S</span>
<span xmlns="http://www.w3.org/1999/xhtml" class="Identifier">AC_PROG_RANLIB</span>
</span></pre>

<p>
对于不标准的应用，你可能会看到手动检查：
</p>

<pre><span class=""><span xmlns="http://www.w3.org/1999/xhtml" class="Comment">dnl</span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment"> </span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment">Check</span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment"> </span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment">for</span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment"> </span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment">sed</span>
<span xmlns="http://www.w3.org/1999/xhtml" class="Identifier">AC_CHECK_PROGS</span><span xmlns="http://www.w3.org/1999/xhtml" class="Special">(</span>regex_cmd<span xmlns="http://www.w3.org/1999/xhtml" class="Special">,</span> sed<span xmlns="http://www.w3.org/1999/xhtml" class="Special">)</span>
<span xmlns="http://www.w3.org/1999/xhtml" class="Statement">if</span> <span xmlns="http://www.w3.org/1999/xhtml" class="Statement">test</span> x$regex_cmd <span xmlns="http://www.w3.org/1999/xhtml" class="Constant">=</span> <span xmlns="http://www.w3.org/1999/xhtml" class="Statement">"</span><span xmlns="http://www.w3.org/1999/xhtml" class="Constant">x</span><span xmlns="http://www.w3.org/1999/xhtml" class="Statement">"</span> <span xmlns="http://www.w3.org/1999/xhtml" class="Statement">;</span> <span xmlns="http://www.w3.org/1999/xhtml" class="Statement">then</span>
    <span xmlns="http://www.w3.org/1999/xhtml" class="Identifier">AC_MSG_ERROR</span><span xmlns="http://www.w3.org/1999/xhtml" class="Special">(</span><span xmlns="http://www.w3.org/1999/xhtml" class="Special">[</span>sed is required to build the data files.]<span xmlns="http://www.w3.org/1999/xhtml" class="Special">)</span>
<span xmlns="http://www.w3.org/1999/xhtml" class="Statement">fi</span>
</span></pre>

<p>
你也可能见到对编译器功能的检查：
</p>

<pre><span class=""><span xmlns="http://www.w3.org/1999/xhtml" class="Comment">dnl</span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment"> </span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment">Check</span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment"> </span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment">that</span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment"> </span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment">our</span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment"> </span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment">compiler</span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment"> </span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment">can</span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment"> </span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment">do</span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment"> </span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment">const</span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment"> </span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment">and</span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment"> </span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment">inline</span>
<span xmlns="http://www.w3.org/1999/xhtml" class="Identifier">AC_C_CONST</span>
<span xmlns="http://www.w3.org/1999/xhtml" class="Identifier">AC_C_INLINE</span>
</span></pre>

<p>
库和头文件的检查：
</p>

<pre><span class=""><span xmlns="http://www.w3.org/1999/xhtml" class="Comment">dnl</span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment"> </span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment">Check</span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment"> </span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment">for</span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment"> </span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment">standard</span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment"> </span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment">headers:</span>
<span xmlns="http://www.w3.org/1999/xhtml" class="Identifier">AC_HEADER_STDC</span>
<span xmlns="http://www.w3.org/1999/xhtml" class="Identifier">AC_HEADER_DIRENT</span>
<span xmlns="http://www.w3.org/1999/xhtml" class="Identifier">AC_CHECK_HEADERS</span><span xmlns="http://www.w3.org/1999/xhtml" class="Special">(</span><span xmlns="http://www.w3.org/1999/xhtml" class="Special">[</span>stdlib.h stdio.h libintl.h locale.h]<span xmlns="http://www.w3.org/1999/xhtml" class="Special">)</span>

<span xmlns="http://www.w3.org/1999/xhtml" class="Comment">dnl</span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment"> </span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment">Check</span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment"> </span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment">for</span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment"> </span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment">libraries:</span>
<span xmlns="http://www.w3.org/1999/xhtml" class="Identifier">AC_CHECK_LIB</span><span xmlns="http://www.w3.org/1999/xhtml" class="Special">(</span>ssl<span xmlns="http://www.w3.org/1999/xhtml" class="Special">,</span> SSL_free<span xmlns="http://www.w3.org/1999/xhtml" class="Special">)</span>
</span></pre>

<p>
以及函数检查：
</p>

<pre><span class=""><span xmlns="http://www.w3.org/1999/xhtml" class="Comment">dnl</span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment"> </span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment">Check</span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment"> </span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment">for</span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment"> </span><span xmlns="http://www.w3.org/1999/xhtml" class="Comment">functions:</span>
<span xmlns="http://www.w3.org/1999/xhtml" class="Identifier">AC_CHECK_FUNCS</span><span xmlns="http://www.w3.org/1999/xhtml" class="Special">(</span><span xmlns="http://www.w3.org/1999/xhtml" class="Special">[</span>setlocale strtol]<span xmlns="http://www.w3.org/1999/xhtml" class="Special">)</span>
</span></pre>

<p>
这些东西常常会混杂在一起而不带任何有用的注释。有些情况下，很多检查甚至都不是应用所必须的 —— 大多数 autotools 代码都是复制/粘贴，而不是从头开始手写的，
并且 <code class="docutils literal"><span class="pre">autoscan</span></code>（一个用来帮助撰写 <code class="docutils literal"><span class="pre">configure.ac</span></code> 的工具）有时过分渴望添加检查。
</p>

<p>
文件会在一些输出函数处结束：
</p>

<pre><span class=""><span xmlns="http://www.w3.org/1999/xhtml" class="Identifier">AM_CONFIG_HEADER</span><span xmlns="http://www.w3.org/1999/xhtml" class="Special">(</span>config.h<span xmlns="http://www.w3.org/1999/xhtml" class="Special">)</span>
<span xmlns="http://www.w3.org/1999/xhtml" class="Identifier">AC_OUTPUT</span><span xmlns="http://www.w3.org/1999/xhtml" class="Special">(</span>Makefile src/Makefile nls/Makefile man/Makefile tests/Makefile<span xmlns="http://www.w3.org/1999/xhtml" class="Special">)</span>
</span></pre>

<p>
它们用来让 <code class="docutils literal"><span class="pre">./configure</span></code> 脚本生成相关的文件。
</p>

</div>
<div class="section">
<h3 id="enable-and-disable-checks">Enable 与 Disable 检查</h3>

<p>
到目前为止我们只看到了‘硬’依赖。许多软件包都有对各种副产品（图形化工具，功能性的库，解释器，额外特性，...）的<i>可选</i>支持。
这些支持（如果幸运的话）通过由 <code class="docutils literal"><span class="pre">autoconf</span></code> 规则生成的
<code class="docutils literal"><span class="pre">./configure</span></code> 脚本的
<code class="docutils literal"><span class="pre">--enable-foo</span></code> 和
<code class="docutils literal"><span class="pre">--disable-foo</span></code> 开关处理。
</p>

<p>
一个简单的 <code class="docutils literal"><span class="pre">--enable</span></code> / <code class="docutils literal"><span class="pre">--disable</span></code>
功能看起来应该如下所示：
</p>

<pre><span class=""><span xmlns="http://www.w3.org/1999/xhtml" class="Identifier">AC_MSG_CHECKING</span><span xmlns="http://www.w3.org/1999/xhtml" class="Special">(</span>--enable-cscope argument<span xmlns="http://www.w3.org/1999/xhtml" class="Special">)</span>
<span xmlns="http://www.w3.org/1999/xhtml" class="Identifier">AC_ARG_ENABLE</span><span xmlns="http://www.w3.org/1999/xhtml" class="Special">(</span>cscope<span xmlns="http://www.w3.org/1999/xhtml" class="Special">,</span>
    <span xmlns="http://www.w3.org/1999/xhtml" class="Special">[</span>  --enable-cscope         Include cscope interface.<span xmlns="http://www.w3.org/1999/xhtml" class="Special">],</span>
    <span xmlns="http://www.w3.org/1999/xhtml" class="Special">[</span>enable_cscope<span xmlns="http://www.w3.org/1999/xhtml" class="Constant">=</span>$enableval<span xmlns="http://www.w3.org/1999/xhtml" class="Special">],</span>
    <span xmlns="http://www.w3.org/1999/xhtml" class="Special">[</span>enable_cscope<span xmlns="http://www.w3.org/1999/xhtml" class="Constant">=</span><span xmlns="http://www.w3.org/1999/xhtml" class="Statement">"</span><span xmlns="http://www.w3.org/1999/xhtml" class="Constant">no</span><span xmlns="http://www.w3.org/1999/xhtml" class="Statement">"</span><span xmlns="http://www.w3.org/1999/xhtml" class="Statement">]</span><span xmlns="http://www.w3.org/1999/xhtml" class="Special">)</span>
<span xmlns="http://www.w3.org/1999/xhtml" class="Identifier">AC_MSG_RESULT</span><span xmlns="http://www.w3.org/1999/xhtml" class="Special">(</span>$enable_cscope<span xmlns="http://www.w3.org/1999/xhtml" class="Special">)</span>
<span xmlns="http://www.w3.org/1999/xhtml" class="Statement">if</span> <span xmlns="http://www.w3.org/1999/xhtml" class="Statement">test</span> <span xmlns="http://www.w3.org/1999/xhtml" class="Statement">"</span><span xmlns="http://www.w3.org/1999/xhtml" class="Constant"><span class="Identifier">$enable_cscope</span></span><span xmlns="http://www.w3.org/1999/xhtml" class="Statement">"</span> <span xmlns="http://www.w3.org/1999/xhtml" class="Constant">=</span> <span xmlns="http://www.w3.org/1999/xhtml" class="Statement">"</span><span xmlns="http://www.w3.org/1999/xhtml" class="Constant">yes</span><span xmlns="http://www.w3.org/1999/xhtml" class="Statement">"</span><span xmlns="http://www.w3.org/1999/xhtml" class="Statement">;</span> <span xmlns="http://www.w3.org/1999/xhtml" class="Statement">then</span>
  <span xmlns="http://www.w3.org/1999/xhtml" class="Identifier">AC_DEFINE</span><span xmlns="http://www.w3.org/1999/xhtml" class="Special">(</span>FEAT_CSCOPE<span xmlns="http://www.w3.org/1999/xhtml" class="Special">)</span>
<span xmlns="http://www.w3.org/1999/xhtml" class="Statement">fi</span>
</span></pre>

<p>
有时候根据一个选项是否启用会进行更复杂的检查。另外还有一些包含了
<code class="docutils literal"><span class="pre">AC_ARG_ENABLE</span></code>
的预定义宏。所以用 grep 扫描 <code class="docutils literal"><span class="pre">configure.ac</span></code>
去找 <code class="docutils literal"><span class="pre">AC_ARG_ENABLE</span></code> 可能会找不全，更好的方法是用
<code class="docutils literal"><span class="pre">./configure --help</span></code> 然后查看输出。
</p>

<div class="alert alert-warning" role="alert">
<strong>重要：</strong>
第三、第四个参数是2段代码，第三个参数在给出了 <code class="docutils literal"><span class="pre">./configure</span></code> 的
<code class="docutils literal"><span class="pre">--enable</span></code> 或 <code class="docutils literal"><span class="pre">--disable</span></code>
开关时执行，而第四个参数在<i>没有</i>给出这2个开关时执行。一个常见的误解是第三个参数是 enable 的，第四个参数是 disable 的 —— 事实<b>并非</b>如此。
你可能会遇到有的软件包在这个地方弄错。
</div>

<p>
一个检查软件包是否正确使用这个宏的简单方法是安装可选项的依赖，然后尝试
<code class="docutils literal"><span class="pre">./configure</span></code>，
<code class="docutils literal"><span class="pre">./configure --enable-foo</span></code> 和
<code class="docutils literal"><span class="pre">./configure --disable-foo</span></code>，
如果第二次和第三次运行产生了相同的结果，就说明某个地方写错了。如果第一次运行的结果和后两次都<i>不相同</i>，那很有可能是对
<code class="docutils literal"><span class="pre">AC_ARG_ENABLE</span></code> 参数的误解造成的。
</p>

</div>
<div class="section">
<h3 id="with-and-without-checks">With 与 Without 检查</h3>

<p>
一个简单的 <code class="docutils literal"><span class="pre">--with</span></code> / <code class="docutils literal"><span class="pre">--without</span></code> 检查如下所示：
</p>

<pre><span class=""><span xmlns="http://www.w3.org/1999/xhtml" class="Identifier">AC_MSG_CHECKING</span><span xmlns="http://www.w3.org/1999/xhtml" class="Special">(</span><span xmlns="http://www.w3.org/1999/xhtml" class="Special">[</span>whether to enable foo]<span xmlns="http://www.w3.org/1999/xhtml" class="Special">)</span>
<span xmlns="http://www.w3.org/1999/xhtml" class="Identifier">AC_ARG_WITH</span><span xmlns="http://www.w3.org/1999/xhtml" class="Special">(</span>foo<span xmlns="http://www.w3.org/1999/xhtml" class="Special">,</span>
    <span xmlns="http://www.w3.org/1999/xhtml" class="Special">[</span>  --with-foo           enable foo support<span xmlns="http://www.w3.org/1999/xhtml" class="Special">],</span>
    with_foo<span xmlns="http://www.w3.org/1999/xhtml" class="Constant">=</span>$withval<span xmlns="http://www.w3.org/1999/xhtml" class="Special">,</span>
    with_foo<span xmlns="http://www.w3.org/1999/xhtml" class="Constant">=</span>yes<span xmlns="http://www.w3.org/1999/xhtml" class="Special">)</span>
<span xmlns="http://www.w3.org/1999/xhtml" class="Identifier">AC_MSG_RESULT</span><span xmlns="http://www.w3.org/1999/xhtml" class="Special">(</span>$with_foo<span xmlns="http://www.w3.org/1999/xhtml" class="Special">)</span>
</span></pre>

<p>
同样的，第三个参数在‘指定’时执行，第四个参数在‘未指定’时执行，并且有一些标准宏包含了
<code class="docutils literal"><span class="pre">with</span></code> 选项。
</p>

</div>
<div class="section">
<h3 id="automatic-checks">自动检查</h3>

<p>
编写能绕开或忽略 enable / disable 的 autoconf 规则是完全有可能的，
如果你的软件包就是这么做的，请务必修复它以避免出现依赖问题。
</p>

<p>
软件包仅仅使用 <code class="docutils literal"><span class="pre">AC_CHECK_LIB</span></code>
来决定一项特性启用与否是最常见的形式，如果你发现有软件包这么做，请<b>务必</b>修改。
</p>

</div>
<div class="section">
<h3 id="quoting-rules-for-configure.ac"><code class="docutils literal"><span class="pre">configure.ac</span></code> 中的引用规则
</h3>

<p>
在后台，<code class="docutils literal"><span class="pre">autoconf</span></code> 大量使用
<code class="docutils literal"><span class="pre">m4</span></code>
宏处理器来完成操作。<code class="docutils literal"><span class="pre">m4</span></code> 引用字符由
<code class="docutils literal"><span class="pre">autoconf</span></code> 设置为
<code class="docutils literal"><span class="pre">[</span></code> 和
<code class="docutils literal"><span class="pre">]</span></code>，分别代表开始和结束引用。使用
<code class="docutils literal"><span class="pre">"</span></code> 或
<code class="docutils literal"><span class="pre">'</span></code> 可能会造成意想不到的结果。
</p>

<p>
要包含一个左方括号字符，最简单的方法是使用特殊字符串
<code class="docutils literal"><span class="pre">@&lt;:@</span></code>，对于右方括号则是使用
<code class="docutils literal"><span class="pre">@:&gt;@</span></code>。
</p>

<p>
例如：
</p>

<pre><span class=""><span xmlns="http://www.w3.org/1999/xhtml" class="Identifier">AC_MSG_RESULT</span><span xmlns="http://www.w3.org/1999/xhtml" class="Special">(</span>the first<span xmlns="http://www.w3.org/1999/xhtml" class="Special">)</span>
<span xmlns="http://www.w3.org/1999/xhtml" class="Identifier">AC_MSG_RESULT</span><span xmlns="http://www.w3.org/1999/xhtml" class="Special">(</span><span xmlns="http://www.w3.org/1999/xhtml" class="Special">[</span>the second]<span xmlns="http://www.w3.org/1999/xhtml" class="Special">)</span>
<span xmlns="http://www.w3.org/1999/xhtml" class="Identifier">AC_MSG_RESULT</span><span xmlns="http://www.w3.org/1999/xhtml" class="Special">(</span><span xmlns="http://www.w3.org/1999/xhtml" class="Statement">"</span><span xmlns="http://www.w3.org/1999/xhtml" class="Constant">the</span><span xmlns="http://www.w3.org/1999/xhtml" class="Constant"> </span><span xmlns="http://www.w3.org/1999/xhtml" class="Constant">third</span><span xmlns="http://www.w3.org/1999/xhtml" class="Statement">"</span><span xmlns="http://www.w3.org/1999/xhtml" class="Special">)</span>
<span xmlns="http://www.w3.org/1999/xhtml" class="Identifier">AC_MSG_RESULT</span><span xmlns="http://www.w3.org/1999/xhtml" class="Special">(</span>@&lt;:@the fourth@:&gt;@<span xmlns="http://www.w3.org/1999/xhtml" class="Special">)</span>
<span xmlns="http://www.w3.org/1999/xhtml" class="Identifier">AC_MSG_RESULT</span><span xmlns="http://www.w3.org/1999/xhtml" class="Special">(</span><span xmlns="http://www.w3.org/1999/xhtml" class="Special">[</span>@&lt;:@the fifth@:&gt;@]<span xmlns="http://www.w3.org/1999/xhtml" class="Special">)</span>
</span></pre>

<p>
处理为：
</p>

<pre>
    the first
    the second
    "the third"
    [the fourth]
    [the fifth]
</pre>

<p>
当拿不准的时候，最保险的方法是用
<code class="docutils literal"><span class="pre">[ ]</span></code>
引用宏参数而不是放着不管。
</p>

</div>
</div>
<div class="section">
<h2 id="the-makefile.am-files"><code class="docutils literal"><span class="pre">Makefile.am</span></code> 文件</h2>

<p>
<code class="docutils literal"><span class="pre">Makefile.am</span></code> 由 <code class="docutils literal"><span class="pre">automake</span></code> 处理并生成
<code class="docutils literal"><span class="pre">Makefile.in</span></code>，<code class="docutils literal"><span class="pre">Makefile.in</span></code> 由
<code class="docutils literal"><span class="pre">configure</span></code> 处理并生成
<code class="docutils literal"><span class="pre">Makefile</span></code>，最终 <code class="docutils literal"><span class="pre">make</span></code> 根据
<code class="docutils literal"><span class="pre">Makefile</span></code> 构建软件。
</p>

<p>
<code class="docutils literal"><span class="pre">Makefile.am</span></code> 的基本格式类似于
<code class="docutils literal"><span class="pre">Makefile</span></code>，不过你会看到文件中设置了各种‘特殊的’变量而不是手写每一条规则。
</p>

<p>
一个非常简单的例子：
</p>

<pre><span class=""><span xmlns="http://www.w3.org/1999/xhtml" class="Type">bin_PROGRAMS</span> <span xmlns="http://www.w3.org/1999/xhtml" class="Constant">=</span> myapp
<span xmlns="http://www.w3.org/1999/xhtml" class="Type">myapp_SOURCES</span> <span xmlns="http://www.w3.org/1999/xhtml" class="Constant">=</span> myapp_commandline.c myapp.c
</span></pre>

<p>
这样所有的 GNU 标准规则都可以生成，<code class="docutils literal"><span class="pre">make</span></code>、<code class="docutils literal"><span class="pre">make clean</span></code>、<code class="docutils literal"><span class="pre">make distclean</span></code>、<code class="docutils literal"><span class="pre">make dist</span></code>
以及诸如此类的命令都能正常生效。
</p>

<p>
每当没有处理某项任务的标准 <code class="docutils literal"><span class="pre">automake</span></code>
方法时，你还会见到标准的 <code class="docutils literal"><span class="pre">Makefile</span></code> 构造体，例如：
</p>

<pre><span class=""><span xmlns="http://www.w3.org/1999/xhtml" class="Type">CLEANFILES</span> <span xmlns="http://www.w3.org/1999/xhtml" class="Constant">=</span> glep31check.1
<span xmlns="http://www.w3.org/1999/xhtml" class="Type">man_MANS</span> <span xmlns="http://www.w3.org/1999/xhtml" class="Constant">=</span> glep31check.1
<span xmlns="http://www.w3.org/1999/xhtml" class="Type">EXTRA_DIST</span> <span xmlns="http://www.w3.org/1999/xhtml" class="Constant">=</span> glep31check.in

<span xmlns="http://www.w3.org/1999/xhtml" class="Identifier">%.1</span> <span xmlns="http://www.w3.org/1999/xhtml" class="Identifier">:</span> <span xmlns="http://www.w3.org/1999/xhtml" class="Identifier">%.in</span>
    <span xmlns="http://www.w3.org/1999/xhtml" class="PreProc">@regex_cmd@</span> -e <span xmlns="http://www.w3.org/1999/xhtml" class="Statement">"</span><span xmlns="http://www.w3.org/1999/xhtml" class="Constant">s,\@VERSION\@<span class="Special">,</span><span class="Identifier">$(VERSION)</span>,g</span><span xmlns="http://www.w3.org/1999/xhtml" class="Statement">"</span> <span xmlns="http://www.w3.org/1999/xhtml" class="Identifier">$?</span> <span xmlns="http://www.w3.org/1999/xhtml" class="Identifier">&gt;</span> <span xmlns="http://www.w3.org/1999/xhtml" class="Identifier">$@</span>
</span></pre>

<p>
在这里，<code class="docutils literal"><span class="pre">@regex_cmd@</span></code>
变量会在创建 <code class="docutils literal"><span class="pre">Makefile</span></code> 时由 <code class="docutils literal"><span class="pre">configure</span></code>
检测（在这个例子中是 <code class="docutils literal"><span class="pre">sed</span></code>）并替换。
此过程是通过 <code class="docutils literal"><span class="pre">configure.ac</span></code> 文件里的 <code class="docutils literal"><span class="pre">AC_SUBST(VARNAME)</span></code> 宏处理的。
</p>

<div class="section">
<h3 id="makefile-variables">Makefile 变量</h3>

<p>
有时候，一些有着不良行为的 <code class="docutils literal"><span class="pre">Makefile.am</span></code> 文件会覆盖用户变量，比如
<code class="docutils literal"><span class="pre">CFLAGS</span></code>，这可忍不了 —— 参阅
<a class="" href="../user-environment/index.html#not-filtering-variables">Not Filtering Variables</a>。
在这种情况下就应该使用一些独立的特殊变量，例如对于 <code class="docutils literal"><span class="pre">CFLAGS</span></code>，在
<code class="docutils literal"><span class="pre">Makefile.am</span></code> 中应该使用
<code class="docutils literal"><span class="pre">AM_CFLAGS</span></code> 以免用户的遭到覆盖。
</p>

<p>
所以如果 <code class="docutils literal"><span class="pre">Makefile.am</span></code> 包含了这样的一行：
</p>

<pre><span class="Constant"><span xmlns="http://www.w3.org/1999/xhtml" class="Identifier">CFLAGS</span><span xmlns="http://www.w3.org/1999/xhtml" class="Constant">=</span><span xmlns="http://www.w3.org/1999/xhtml" class="Statement">"</span>-Wall<span xmlns="http://www.w3.org/1999/xhtml" class="Statement">"</span>
</span></pre>

<p>
你用该把它改成：
</p>

<pre><span class="Constant"><span xmlns="http://www.w3.org/1999/xhtml" class="Identifier">AM_CFLAGS</span><span xmlns="http://www.w3.org/1999/xhtml" class="Constant">=</span><span xmlns="http://www.w3.org/1999/xhtml" class="Statement">"</span>-Wall<span xmlns="http://www.w3.org/1999/xhtml" class="Statement">"</span>
</span></pre>

<p>
改完记得手动运行 <code class="docutils literal"><span class="pre">autoconf</span></code> 然后 <code class="docutils literal"><span class="pre">automake</span></code>。
</p>

</div>
</div>
<div class="section">
<h2 id="the-config.h.in-file"><code class="docutils literal"><span class="pre">config.h.in</span></code> 文件</h2>

<p>
<code class="docutils literal"><span class="pre">config.h.in</span></code> 文件是由 <code class="docutils literal"><span class="pre">autoheader</span></code> 生成的。
通常你不用去管它，但偶尔软件包的上游组织没有提供预生成的版本，这时你在构建过程中就需要手动运行 <code class="docutils literal"><span class="pre">autoheader</span></code>。
</p>

</div>
<div class="section">
<h2 id="aclocal-and-m4-files">
<code class="docutils literal"><span class="pre">aclocal</span></code> 与 <code class="docutils literal"><span class="pre">m4</span></code> 文件</h2>

<p>
在 <code class="docutils literal"><span class="pre">configure.ac</span></code> 或 <code class="docutils literal"><span class="pre">configure.in</span></code>
文件中你不仅可以调用由 <code class="docutils literal"><span class="pre">autoconf</span></code> 和 <code class="docutils literal"><span class="pre">automake</span></code>
定义的默认宏，还可以调用由特定软件包（比如库和程序）定义的其他函数，以正确的方式检查它们的功能。
</p>

<p>
这些函数（通常）在软件包置于 <code class="docutils literal"><span class="pre">/usr/share/aclocal</span></code> 目录中的 <code class="docutils literal"><span class="pre">m4</span></code>
文件中定义。由于 <code class="docutils literal"><span class="pre">configure.ac</span></code> 中用到的函数所在的 <code class="docutils literal"><span class="pre">m4</span></code>
文件在用户的系统上不一定安装，所以重新生成 <code class="docutils literal"><span class="pre">autotools</span></code> 文件的时候就容易报错。例如，某些需要库且被
<code class="docutils literal"><span class="pre">USE</span></code> 标志禁用的可选功能就是这种情况。如果
<code class="docutils literal"><span class="pre">m4</span></code> 文件没有安装在用户的系统上，<code class="docutils literal"><span class="pre">autoconf</span></code> 这一步就会失败。
</p>

<p>
为了解决这个问题，大多数软件包在源码的 <code class="docutils literal"><span class="pre">m4</span></code> 目录中只提供了
<code class="docutils literal"><span class="pre">configure.ac</span></code> 所需的 <code class="docutils literal"><span class="pre">m4</span></code>
宏文件。不幸的是，即使有，也不是所有的 <code class="docutils literal"><span class="pre">m4</span></code> 目录都是完整的。
</p>

<p>
在这种情况下你需要找到 <code class="docutils literal"><span class="pre">m4</span></code> 文件，它们一般由依赖安装在
<code class="docutils literal"><span class="pre">/usr/share/aclocal</span></code> 目录下。然后在
<code class="docutils literal"><span class="pre">src_unpack</span></code> 阶段确保这些文件对 autotools 可用，同时调用
<code class="docutils literal"><span class="pre">aclocal</span></code> 生成 <code class="docutils literal"><span class="pre">aclocal.m4</span></code>
文件，以便让 <code class="docutils literal"><span class="pre">autoconf</span></code> 用来生成 configure 脚本。
</p>

<p>
通常情况下会缺少不止一个 <code class="docutils literal"><span class="pre">m4</span></code> 文件，所以你可能需要把它们打成一个压缩包并添加到
<code class="docutils literal"><span class="pre">SRC_URI</span></code>。在确认了该压缩包解压到了 <code class="docutils literal"><span class="pre">${WORKDIR}</span></code>
的某个地方（例如，在 <code class="docutils literal"><span class="pre">gentoo-m4</span></code> 目录中）后，一般有两种通用方法处理这些宏文件，一种用于带有不完整
<code class="docutils literal"><span class="pre">m4</span></code> 目录的软件包，而另一种用于不带 <code class="docutils literal"><span class="pre">m4</span></code> 目录的软件包。
</p>

<p>
在第一种情况下，你通常需要执行以下操作：
</p>

<pre><span class="Constant"><span xmlns="http://www.w3.org/1999/xhtml" class="Statement">einfo</span> <span xmlns="http://www.w3.org/1999/xhtml" class="Statement">"</span>Regenerating autotools files...<span xmlns="http://www.w3.org/1999/xhtml" class="Statement">"</span>
cp <span xmlns="http://www.w3.org/1999/xhtml" class="Statement">"</span><span xmlns="http://www.w3.org/1999/xhtml" class="Identifier">${WORKDIR}</span>/gentoo-m4<span xmlns="http://www.w3.org/1999/xhtml" class="Statement">"</span> <span xmlns="http://www.w3.org/1999/xhtml" class="Statement">"</span><span xmlns="http://www.w3.org/1999/xhtml" class="Identifier">${S}</span>/m4<span xmlns="http://www.w3.org/1999/xhtml" class="Statement">"</span> <span xmlns="http://www.w3.org/1999/xhtml" class="Statement">||</span> <span xmlns="http://www.w3.org/1999/xhtml" class="Statement">die</span> <span xmlns="http://www.w3.org/1999/xhtml" class="Statement">"</span>m4 copy failed<span xmlns="http://www.w3.org/1999/xhtml" class="Statement">"</span>
<span xmlns="http://www.w3.org/1999/xhtml" class="Identifier">WANT_AUTOCONF</span><span xmlns="http://www.w3.org/1999/xhtml" class="Constant">=</span><span xmlns="http://www.w3.org/1999/xhtml" class="Statement">"</span>2.5<span xmlns="http://www.w3.org/1999/xhtml" class="Statement">"</span> aclocal -I <span xmlns="http://www.w3.org/1999/xhtml" class="Statement">"</span><span xmlns="http://www.w3.org/1999/xhtml" class="Identifier">${S}</span>/m4<span xmlns="http://www.w3.org/1999/xhtml" class="Statement">"</span> <span xmlns="http://www.w3.org/1999/xhtml" class="Statement">||</span> <span xmlns="http://www.w3.org/1999/xhtml" class="Statement">die</span> <span xmlns="http://www.w3.org/1999/xhtml" class="Statement">"</span>aclocal failed<span xmlns="http://www.w3.org/1999/xhtml" class="Statement">"</span>
<span xmlns="http://www.w3.org/1999/xhtml" class="Identifier">WANT_AUTOCONF</span><span xmlns="http://www.w3.org/1999/xhtml" class="Constant">=</span><span xmlns="http://www.w3.org/1999/xhtml" class="Statement">"</span>2.5<span xmlns="http://www.w3.org/1999/xhtml" class="Statement">"</span> autoconf <span xmlns="http://www.w3.org/1999/xhtml" class="Statement">||</span> <span xmlns="http://www.w3.org/1999/xhtml" class="Statement">die</span> <span xmlns="http://www.w3.org/1999/xhtml" class="Statement">"</span>autoconf failed<span xmlns="http://www.w3.org/1999/xhtml" class="Statement">"</span>
</span></pre>

<p>
在第二种情况下，你可以像这样简化操作：
</p>

<pre><span class="Constant"><span xmlns="http://www.w3.org/1999/xhtml" class="Statement">einfo</span> <span xmlns="http://www.w3.org/1999/xhtml" class="Statement">"</span>Regenerating autotools files...<span xmlns="http://www.w3.org/1999/xhtml" class="Statement">"</span>
<span xmlns="http://www.w3.org/1999/xhtml" class="Identifier">WANT_AUTOCONF</span><span xmlns="http://www.w3.org/1999/xhtml" class="Constant">=</span><span xmlns="http://www.w3.org/1999/xhtml" class="Statement">"</span>2.5<span xmlns="http://www.w3.org/1999/xhtml" class="Statement">"</span> aclocal -I <span xmlns="http://www.w3.org/1999/xhtml" class="Statement">"</span><span xmlns="http://www.w3.org/1999/xhtml" class="Identifier">${WORKDIR}</span>/gentoo-m4<span xmlns="http://www.w3.org/1999/xhtml" class="Statement">"</span> <span xmlns="http://www.w3.org/1999/xhtml" class="Statement">||</span> <span xmlns="http://www.w3.org/1999/xhtml" class="Statement">die</span> <span xmlns="http://www.w3.org/1999/xhtml" class="Statement">"</span>aclocal failed<span xmlns="http://www.w3.org/1999/xhtml" class="Statement">"</span>
<span xmlns="http://www.w3.org/1999/xhtml" class="Identifier">WANT_AUTOCONF</span><span xmlns="http://www.w3.org/1999/xhtml" class="Constant">=</span><span xmlns="http://www.w3.org/1999/xhtml" class="Statement">"</span>2.5<span xmlns="http://www.w3.org/1999/xhtml" class="Statement">"</span> autoconf <span xmlns="http://www.w3.org/1999/xhtml" class="Statement">||</span> <span xmlns="http://www.w3.org/1999/xhtml" class="Statement">die</span> <span xmlns="http://www.w3.org/1999/xhtml" class="Statement">"</span>autoconf failed<span xmlns="http://www.w3.org/1999/xhtml" class="Statement">"</span>
</span></pre>

<p>
而无需复制文件。
</p>

<p>
当发行版中缺少 <code class="docutils literal"><span class="pre">m4</span></code>
文件时最好的办法是通知上游组织，让他们在源码包里添加所需的文件以避免宏更改时的版本冲突。
</p>

</div>
<div class="section">
<h2 id="libtool">Libtool</h2>

<div class="alert alert-info" role="alert">
<strong>待办：</strong>
关于 libtool, libtoolize, elibtoolize, libtool.eclass 的东西。原文作者不懂...
</div>

</div>
<div class="section">
<h2 id="further-autotools-reading">Autotools 进一步学习</h2>

<p>
更多 autotools 的细节请阅读：
</p>

<ul>
  <li>
    书籍《GNU Autoconf, Automake and Libtool》（简称“The Autobook”）。作者 Gary V. Vaughan，Ben
    Elliston，Tom Tromey，Ian Lance Taylor。讲的不错但略显过时。可以
    <a class="" href="https://sourceware.org/autobook/">免费在线阅读</a>。
  </li>
  <li>
    各种 autotools 组件的 GNU 文档，质量和完成度都参差不齐：
    <ul>
    <li>
      <a class="" href="https://www.gnu.org/software/automake/manual/automake.html">
        GNU automake Manual
      </a>
    </li>
    <li>
      <a class="" href="https://www.gnu.org/software/autoconf/manual/">GNU autoconf Manual</a>
    </li>
    <li>
      <a class="" href="https://www.gnu.org/software/libtool/manual/">GNU libtool Manual</a>
    </li>
    <li>
      <a class="" href="https://www.gnu.org/software/m4/manual/m4.html">GNU m4 Manual</a>
    </li>
    <li>
      <a class="" href="https://autotools.io">Autotools Mythbuster</a>
    </li>
    </ul>
  </li>
  <li>
    一些
    <a class="" href="https://www.shlomifish.org/lecture/Autotools/">在线课程</a>。
  </li>
</ul>

</div>
</div></main><footer><div class="container">
<div class="row">
<div class="col-xs-12 col-md-offset-2 col-md-7"></div>
<div class="col-xs-12 col-md-3">
<h3 class="footerhead">Questions or comments?</h3>
                Please feel free to <a href="https://www.gentoo.org/inside-gentoo/contact/">contact us</a>.
              </div>
</div>
<div class="row">
<div class="col-xs-2 col-sm-3 col-md-2"><ul class="footerlinks three-icons">
<li><a href="https://twitter.com/gentoo" title="@Gentoo on Twitter"><span class="fa fa-twitter fa-fw"></span></a></li>
<li><a href="https://www.facebook.com/gentoo.org" title="Gentoo on Facebook"><span class="fa fa-facebook fa-fw"></span></a></li>
</ul></div>
<div class="col-xs-10 col-sm-9 col-md-10">
<strong>Copyright (C) 2001-2021 Gentoo Authors</strong><br><small>
                Gentoo is a trademark of the Gentoo Foundation, Inc.
                The text of this document is distributed under the
                <a href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.
                The <a href="https://www.gentoo.org/inside-gentoo/foundation/name-logo-guidelines.html">Gentoo Name and Logo Usage Guidelines</a> apply.
              </small>
</div>
</div>
</div></footer><script src="/assets.gentoo.org/tyrian/jquery.min.js"></script><script src="/assets.gentoo.org/tyrian/bootstrap.min.js"></script><script src="/assets.gentoo.org/lunr/lunr.min.js"></script><script>var documentsSrc = "../../documents.js"</script><script src="../../search.js"></script>
</body>
</html>
